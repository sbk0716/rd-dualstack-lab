#!/bin/sh
# =============================================================================
# 接続テストスクリプト
# =============================================================================
# 目的: Dual Stack ネットワーク環境で IPv4/IPv6 の疎通を確認する
#
# 実行方法:
#   # コンテナ内で実行（事前にツールのインストールが必要）
#   docker exec -it rd-ds-client sh
#   /scripts/test-connectivity.sh
#
#   # または、ホストからコピーして実行
#   docker cp scripts/test-connectivity.sh rd-ds-client:/tmp/
#   docker exec rd-ds-client /tmp/test-connectivity.sh
#
# 前提条件:
#   - setup-client.sh でツールがインストール済み
#   - または apk add --no-cache curl bind-tools iputils を実行済み
#
# テスト内容:
#   1. IP アドレス直指定での HTTP アクセス（IPv4/IPv6）
#   2. Ping での ICMP 疎通確認（IPv4/IPv6）
#   3. DNS による名前解決（A レコード/AAAA レコード）
#   4. ドメイン名経由での HTTP 接続（IPv6 優先を確認）
# =============================================================================

# -----------------------------------------------------------------------------
# シェルオプション設定
# -----------------------------------------------------------------------------
# set -e: コマンドがエラーで終了した場合、スクリプトを即座に終了
set -e

# -----------------------------------------------------------------------------
# テスト開始メッセージ
# -----------------------------------------------------------------------------
echo "=========================================="
echo "Dual Stack Lab - 接続テスト"
echo "=========================================="
echo ""
echo "テスト対象:"
echo "  Web サーバ (nginx)"
echo "    IPv4: 172.30.0.10"
echo "    IPv6: fd00:dead:beef::10"
echo ""
echo "  DNS サーバ (CoreDNS)"
echo "    IPv4: 172.30.0.53"
echo "    IPv6: fd00:dead:beef::53"
echo ""

# =============================================================================
# テスト 1: IP アドレス直指定での HTTP アクセス
# =============================================================================
# curl を使って nginx に直接アクセス
# -4: IPv4 のみを使用
# -6: IPv6 のみを使用
# -g: URL 内の [] をグロブとして解釈しない（IPv6 アドレス用）
# -sS: サイレントモード（プログレス非表示）+ エラーは表示
echo "### テスト 1: IP 直指定での HTTP アクセス ###"
echo ""

echo "[IPv4] curl -4 http://172.30.0.10/"
echo "---------------------------------------"
curl -4 -sS http://172.30.0.10/ | head -n 3
echo ""
echo "→ IPv4 で nginx に正常にアクセスできました"
echo ""

echo "[IPv6] curl -6 -g http://[fd00:dead:beef::10]/"
echo "---------------------------------------"
# IPv6 アドレスは [] で囲む必要がある（RFC 2732）
# ポート番号と : を区別するため
curl -6 -g -sS http://[fd00:dead:beef::10]/ | head -n 3
echo ""
echo "→ IPv6 で nginx に正常にアクセスできました"
echo ""

# =============================================================================
# テスト 2: Ping での ICMP 疎通確認
# =============================================================================
# ping を使って ICMP Echo Request/Reply を確認
# -c 2: 2 回だけ ping を送信
echo "### テスト 2: Ping による ICMP 疎通確認 ###"
echo ""

echo "[IPv4] ping -c 2 172.30.0.10"
echo "---------------------------------------"
ping -c 2 172.30.0.10
echo ""
echo "→ IPv4 で ICMP 疎通を確認しました"
echo ""

echo "[IPv6] ping -c 2 fd00:dead:beef::10"
echo "---------------------------------------"
# IPv6 の ping も同じコマンドで実行可能（BusyBox の場合）
# 一部の環境では ping6 コマンドが必要
ping -c 2 fd00:dead:beef::10
echo ""
echo "→ IPv6 で ICMP 疎通を確認しました"
echo ""

# =============================================================================
# テスト 3: DNS 名前解決
# =============================================================================
# dig を使って CoreDNS に DNS クエリを送信
# A: IPv4 アドレスを問い合わせ
# AAAA: IPv6 アドレスを問い合わせ
# +short: 簡潔な出力（アドレスのみ）
echo "### テスト 3: DNS 名前解決 ###"
echo ""

echo "[A レコード] dig dual-ok.local A +short"
echo "---------------------------------------"
dig dual-ok.local A +short
echo ""
echo "→ A レコード（IPv4）が正しく返されました"
echo ""

echo "[AAAA レコード] dig dual-ok.local AAAA +short"
echo "---------------------------------------"
dig dual-ok.local AAAA +short
echo ""
echo "→ AAAA レコード（IPv6）が正しく返されました"
echo ""

# =============================================================================
# テスト 4: ドメイン名経由での HTTP 接続
# =============================================================================
# curl にドメイン名を指定して接続
# DNS で A と AAAA の両方を取得し、IPv6 を優先して接続する
# -v: 詳細出力（接続先アドレスを確認するため）
echo "### テスト 4: ドメイン名経由での接続 ###"
echo ""

echo "[dual-ok.local] curl -v http://dual-ok.local/"
echo "---------------------------------------"
echo "期待される動作: IPv6 を優先して接続"
echo ""
# grep で接続情報のみを抽出
# Trying: 接続試行中のアドレス
# Connected: 接続成功したアドレス
# HTTP/: HTTP レスポンスのステータスライン
curl -v http://dual-ok.local/ 2>&1 | grep -E "Trying|Connected|HTTP/" | head -n 5
echo ""
echo "→ IPv6 優先で接続されたことを確認しました"
echo ""

# -----------------------------------------------------------------------------
# テスト完了メッセージ
# -----------------------------------------------------------------------------
echo "=========================================="
echo "すべてのテストが完了しました！"
echo "=========================================="
echo ""
echo "結果サマリ:"
echo "  ✓ IPv4 HTTP アクセス: OK"
echo "  ✓ IPv6 HTTP アクセス: OK"
echo "  ✓ IPv4 Ping: OK"
echo "  ✓ IPv6 Ping: OK"
echo "  ✓ DNS A レコード: OK"
echo "  ✓ DNS AAAA レコード: OK"
echo "  ✓ ドメイン名経由接続: OK（IPv6 優先）"
echo ""
