# =============================================================================
# Dual Stack Lab - Docker Compose 設定ファイル
# =============================================================================
# 目的: IPv4/IPv6 Dual Stack 環境を構築し、疎通確認・フォールバック動作を検証する
# 環境: Rancher Desktop (macOS / dockerd) または Docker Desktop
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Web サーバ (nginx)
  # ---------------------------------------------------------------------------
  # 役割: HTTP リクエストを受け付けるテスト用 Web サーバ
  # IPv4/IPv6 両方のアドレスでアクセス可能
  # ---------------------------------------------------------------------------
  web:
    # 軽量な Alpine Linux ベースの nginx イメージを使用
    image: nginx:alpine
    # コンテナ名を固定（docker exec で入りやすくするため）
    container_name: rd-ds-web
    # Dual Stack ネットワークに接続
    networks:
      dsnet:
        # IPv4 アドレスを固定割り当て（172.30.0.10）
        ipv4_address: 172.30.0.10
        # IPv6 アドレスを固定割り当て（fd00:dead:beef::10）
        # fd00::/8 は ULA（Unique Local Address）= プライベート IPv6 アドレス
        ipv6_address: fd00:dead:beef::10

  # ---------------------------------------------------------------------------
  # DNS サーバ (CoreDNS)
  # ---------------------------------------------------------------------------
  # 役割: A レコード（IPv4）と AAAA レコード（IPv6）を返す DNS サーバ
  # dual-ok.local: 正常な Dual Stack レコード
  # dual-badv6.local: 壊れた AAAA レコード（フォールバックテスト用）
  # ---------------------------------------------------------------------------
  dns:
    # CoreDNS の公式イメージ（バージョン固定で再現性を確保）
    image: coredns/coredns:1.11.1
    # コンテナ名を固定
    container_name: rd-ds-dns
    # CoreDNS の設定ファイル（Corefile）を指定して起動
    command: ["-conf", "/Corefile"]
    # ホストの Corefile をコンテナ内にマウント（読み取り専用）
    volumes:
      - ./Corefile:/Corefile:ro
    # Dual Stack ネットワークに接続
    networks:
      dsnet:
        # DNS サーバらしく .53 を使用（IPv4）
        ipv4_address: 172.30.0.53
        # DNS サーバらしく ::53 を使用（IPv6）
        ipv6_address: fd00:dead:beef::53

  # ---------------------------------------------------------------------------
  # テストクライアント (Alpine Linux)
  # ---------------------------------------------------------------------------
  # 役割: curl, dig, ping などのコマンドを実行するクライアント
  # このコンテナに docker exec で入ってテストを実施する
  # ---------------------------------------------------------------------------
  client:
    # 軽量な Alpine Linux イメージ（バージョン固定）
    image: alpine:3.20
    # コンテナ名を固定（docker exec rd-ds-client sh で入る）
    container_name: rd-ds-client
    # コンテナを起動したままにするため、無限スリープを実行
    # （通常のコンテナはプロセスが終了すると停止してしまう）
    command: ["sh", "-c", "sleep infinity"]
    # Web サーバと DNS サーバが起動してから開始
    depends_on:
      - web
      - dns
    # DNS サーバとして CoreDNS コンテナを使用
    # これにより dual-ok.local などの名前解決が可能になる
    dns:
      - 172.30.0.53
    # Dual Stack ネットワークに接続
    networks:
      dsnet:
        # クライアント用の IPv4 アドレス
        ipv4_address: 172.30.0.20
        # クライアント用の IPv6 アドレス
        ipv6_address: fd00:dead:beef::20

# =============================================================================
# ネットワーク設定
# =============================================================================
networks:
  # ---------------------------------------------------------------------------
  # dsnet: Dual Stack Network
  # ---------------------------------------------------------------------------
  # IPv4 と IPv6 の両方が有効なブリッジネットワーク
  # すべてのコンテナがこのネットワークに接続される
  # ---------------------------------------------------------------------------
  dsnet:
    # ブリッジドライバを使用（Docker のデフォルト）
    # コンテナ間通信が可能になる
    driver: bridge
    # ★重要★ IPv6 を有効化（デフォルトは false）
    # これを true にしないと IPv6 アドレスが割り当てられない
    enable_ipv6: true
    # IPAM (IP Address Management): IP アドレスの割り当て設定
    ipam:
      config:
        # IPv4 サブネット: 172.30.0.0/24
        # 使用可能アドレス: 172.30.0.1 〜 172.30.0.254
        - subnet: 172.30.0.0/24
        # IPv6 サブネット: fd00:dead:beef::/64
        # fd00::/8 は ULA（プライベート IPv6）
        # /64 は標準的なサブネットサイズ（2^64 個のアドレス）
        - subnet: fd00:dead:beef::/64
