# =============================================================================
# CoreDNS 設定ファイル (Corefile)
# =============================================================================
# 目的: Dual Stack ラボ環境用の DNS サーバ設定
#       A レコード（IPv4）と AAAA レコード（IPv6）の両方を返す
#
# 使用方法:
#   CoreDNS コンテナ起動時に -conf /Corefile オプションで読み込まれる
#
# 参考:
#   - CoreDNS: https://coredns.io/
#   - hosts プラグイン: https://coredns.io/plugins/hosts/
# =============================================================================

# -----------------------------------------------------------------------------
# ゾーン定義: すべてのドメイン（.）を処理
# -----------------------------------------------------------------------------
# "." はルートゾーンを意味し、すべての DNS クエリを処理する
# 中括弧 {} 内にプラグインを記述
. {
  # ---------------------------------------------------------------------------
  # log プラグイン: DNS クエリのログを出力
  # ---------------------------------------------------------------------------
  # すべての DNS クエリをログに記録（デバッグに便利）
  # 出力例: [INFO] 172.30.0.20:45678 - 12345 "A IN dual-ok.local. udp ..."
  log

  # ---------------------------------------------------------------------------
  # errors プラグイン: エラーログを出力
  # ---------------------------------------------------------------------------
  # DNS 処理中のエラーを標準エラー出力に記録
  errors

  # ---------------------------------------------------------------------------
  # hosts プラグイン: ホストファイル形式でレコードを定義
  # ---------------------------------------------------------------------------
  # /etc/hosts と同じ形式で A レコード（IPv4）と AAAA レコード（IPv6）を定義
  # 形式: <IPアドレス> <ホスト名>
  hosts {
    # -------------------------------------------------------------------------
    # dual-ok.local: 正常系テスト用ドメイン
    # -------------------------------------------------------------------------
    # A レコード（IPv4）: 172.30.0.10 → nginx コンテナ
    # AAAA レコード（IPv6）: fd00:dead:beef::10 → nginx コンテナ
    # 両方とも同じ nginx コンテナを指すため、IPv4 でも IPv6 でもアクセス可能
    172.30.0.10 dual-ok.local
    fd00:dead:beef::10 dual-ok.local

    # -------------------------------------------------------------------------
    # dual-badv6.local: IPv6 障害シミュレーション用ドメイン
    # -------------------------------------------------------------------------
    # A レコード（IPv4）: 172.30.0.10 → nginx コンテナ（正常）
    # AAAA レコード（IPv6）: fd00:dead:beef::9999 → 存在しないアドレス（到達不能）
    #
    # このドメインに接続すると:
    #   1. まず IPv6（::9999）への接続を試みる → タイムアウト
    #   2. IPv4（172.30.0.10）にフォールバック → 接続成功
    #
    # これにより「Happy Eyeballs」アルゴリズムの動作を観察できる
    172.30.0.10 dual-badv6.local
    fd00:dead:beef::9999 dual-badv6.local

    # -------------------------------------------------------------------------
    # fallthrough: hosts プラグインで解決できなかった場合、次のプラグインへ
    # -------------------------------------------------------------------------
    # hosts プラグインで定義されていないドメインは、forward プラグインで処理
    fallthrough
  }

  # ---------------------------------------------------------------------------
  # forward プラグイン: 上位 DNS サーバへの転送
  # ---------------------------------------------------------------------------
  # hosts プラグインで解決できなかったドメインを上位 DNS に転送
  # "." はすべてのドメインを転送対象にする
  #
  # 1.1.1.1: Cloudflare Public DNS
  # 8.8.8.8: Google Public DNS
  #
  # 複数指定することで冗長性を確保（1つ目が失敗したら2つ目を使用）
  forward . 1.1.1.1 8.8.8.8
}
