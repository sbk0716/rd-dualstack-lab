#!/bin/bash
# =============================================================================
# Dual Stack Lab 停止スクリプト
# =============================================================================
# 目的: Docker Compose で起動した Dual Stack ラボ環境を停止・クリーンアップする
#
# 実行方法:
#   ./stop.sh
#
# 処理内容:
#   1. すべてのコンテナを停止
#   2. コンテナを削除
#   3. ネットワークを削除
#   4. ボリュームを削除（-v オプション）
# =============================================================================

# -----------------------------------------------------------------------------
# シェルオプション設定
# -----------------------------------------------------------------------------
# set -e: コマンドがエラー（終了コード != 0）で終了した場合、スクリプトを即座に終了
# これにより、途中でエラーが発生した場合に後続の処理が実行されるのを防ぐ
set -e

# -----------------------------------------------------------------------------
# スクリプトのディレクトリに移動
# -----------------------------------------------------------------------------
# $0: 実行されたスクリプトのパス（例: ./stop.sh, /path/to/stop.sh）
# dirname "$0": スクリプトが配置されているディレクトリのパスを取得
# cd "$(...)": そのディレクトリに移動
# pwd: 現在のディレクトリの絶対パスを取得
# この処理により、スクリプトをどこから実行しても正しく動作する
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# -----------------------------------------------------------------------------
# 停止処理の開始メッセージ
# -----------------------------------------------------------------------------
echo "=========================================="
echo "Stopping Dual Stack Lab..."
echo "=========================================="
echo ""

# -----------------------------------------------------------------------------
# Docker Compose でコンテナを停止・削除
# -----------------------------------------------------------------------------
# docker compose down: コンテナを停止して削除
# -v オプション: 関連するボリュームも削除
#   - 匿名ボリューム（anonymous volumes）
#   - compose.yaml で定義された名前付きボリューム
#
# 削除されるリソース:
#   - rd-ds-web コンテナ
#   - rd-ds-dns コンテナ
#   - rd-ds-client コンテナ
#   - rd-dualstack-lab_dsnet ネットワーク
docker compose down -v

# -----------------------------------------------------------------------------
# 完了メッセージ
# -----------------------------------------------------------------------------
echo ""
echo "Lab stopped and cleaned up."
echo "=========================================="
